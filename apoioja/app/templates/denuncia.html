<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Registrar DenÃºncia - ApoioJÃ¡</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header class="topbar">
    <h1 class="brand">ğŸ’™ ApoioJÃ¡</h1>
    <button onclick="panicButton()" class="btn-silent" title="Modo SilÃªncio">ğŸ•µï¸</button>
  </header>

  <main class="page-center">
    <div class="form-container">
      <img src="{{ url_for('static', filename='apoioja_banner.png') }}" alt="Banner ApoioJÃ¡" class="banner-img">

      <h2>Registrar DenÃºncia</h2>
      <p class="subtitle">Seu relato Ã© totalmente anÃ´nimo e protegido.</p>

      <form id="formDenuncia" class="denuncia-form" autocomplete="off" novalidate>
        <div class="form-group">
          <label for="categoria">Categoria</label>
          <input type="text" id="categoria" placeholder="Ex: violÃªncia domÃ©stica" required>
        </div>

        <div class="form-group">
          <label for="local">Local</label>
          <input type="text" id="local" placeholder="Ex: residÃªncia, trabalho, rua..." required>
        </div>

        <div class="form-group">
          <label for="descricao">DescriÃ§Ã£o</label>
          <textarea id="descricao" placeholder="Descreva o ocorrido..." required></textarea>
        </div>

        <div class="actions">
          <button type="submit" class="btn btn-primary">ğŸ“¨ Enviar DenÃºncia</button>
          <button type="button" class="btn btn-secondary" onclick="clearFields()">ğŸ§¹ Limpar Campos</button>
          <button type="button" class="btn btn-secondary" onclick="toggleForm()">ğŸ™ˆ Esconder</button>
        </div>
      </form>

      <p id="mensagem" class="mensagem" role="status"></p>

      <div class="map-container">
        <h3>ğŸ—ºï¸ Mapa de delegacias prÃ³ximas ou ligue 190 </h3>
        <img src="{{ url_for('static', filename='mapa_mock.png') }}" alt="Mapa Simulado" class="map-img">
        <p class="map-caption">Mapa apenas ilustrativo enquanto a integraÃ§Ã£o nÃ£o estÃ¡ pronta.</p>
      </div>
    </div>
  </main>

  <!-- Chatbot widget / botÃ£o -->
  <div id="chatbot" class="chatbot" style="display:none;">
    <div class="chat-header">ğŸ¤– ApoioJÃ¡ Chat</div>
    <div id="chat-box" class="chat-box"></div>
    <div class="chat-input">
      <input id="chatMessage" type="text" placeholder="Escreva aqui..." />
      <button id="sendChat">Enviar</button>
    </div>
  </div>
  <button id="openChat" class="chat-toggle">ğŸ’¬</button>

  <script>
  function clearFields() {
    const form = document.getElementById('formDenuncia');
    form.reset();
  }

  function toggleForm() {
    const form = document.getElementById('formDenuncia');
    form.style.display = (form.style.display === 'none') ? 'block' : 'none';
  }

  function panicButton() {
    try { localStorage.clear(); sessionStorage.clear(); } catch (e) {}
    window.location.href = 'https://www.google.com';
  }

  document.getElementById('formDenuncia').addEventListener('submit', async (e) => {
    e.preventDefault();

    const data = {
      category: document.getElementById('categoria').value.trim(),
      description: document.getElementById('descricao').value.trim(),
      location: document.getElementById('local').value.trim()
    };

    if (!data.category || !data.description || !data.location) {
      document.getElementById('mensagem').innerText = 'Por favor, preencha todos os campos.';
      document.getElementById('mensagem').style.color = '#E74C3C';
      return;
    }

    try {
      const resp = await fetch('/api/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (resp.ok) {
        const json = await resp.json();
        document.getElementById('mensagem').innerText = json.message;
        document.getElementById('mensagem').style.color = '#2E8B57';
        clearFields();
      } else {
        document.getElementById('mensagem').innerText = 'âŒ Erro ao enviar denÃºncia.';
      }
    } catch {
      document.getElementById('mensagem').innerText = 'âš ï¸ Erro ao conectar ao servidor.';
    }
  });

  // Chat widget JS (mesmo do index)
  (function(){
    const chatDiv = document.getElementById("chatbot");
    const toggle = document.getElementById("openChat");
    const sendBtn = document.getElementById("sendChat");
    const chatBox = document.getElementById("chat-box");
    const input = document.getElementById("chatMessage");

    toggle.addEventListener("click", () => {
      const visible = chatDiv.style.display === "block";
      chatDiv.style.display = visible ? "none" : "block";
    });

    async function sendMessage(){
      const text = input.value.trim();
      if(!text) return;
      chatBox.innerHTML += `<div class="user-msg">${escapeHtml(text)}</div>`;
      input.value = "";
      try {
        const resp = await fetch("/api/chat", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({message: text})
        });
        const data = await resp.json();
        chatBox.innerHTML += `<div class="bot-msg">${escapeHtml(data.reply || data.error || "Sem resposta")}</div>`;
      } catch {
        chatBox.innerHTML += `<div class="bot-msg">Erro de conexÃ£o.</div>`;
      }
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    sendBtn.addEventListener("click", sendMessage);
    input.addEventListener("keydown", (e) => { if(e.key === "Enter") sendMessage(); });

    function escapeHtml(unsafe){
      return unsafe.replace(/[&<"'>]/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"})[m]; });
    }
  })();
  </script>
</body>
</html>
